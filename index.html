<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rzt</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-neutral-900 text-white">
    <div class="px-[10vw] md:px-[20vw] lg:px-[30vw] my-[10vw] sm:my-0">
        
        <main class="min-h-screen w-full flex flex-col justify-center items-center">
            <header class="h-full w-full flex justify-center items-center">
                <!-- <a href="index.html"> -->
                    <h1 class="text-8xl font-black mb-8 italic hover:opacity-80">НМД<span class="text-lg">®</span></h1>
                <!-- </a> -->
            </header>
            <section class="w-full" x-data="{
                    rhymes: 5,
                    structure: 5,
                    realize: 5,
                    individual: 5,
                    atmo: 1,
                    coverUrl: null,
                    trackName: '',
                    artistName: '',
                    releaseType: 'single',
                    reviewTitle: '',
                    reviewText: '',
                    errorMessage: '',
                    saving: false,
                    supabase: null,
                    initSupabase() {
                        this.supabase = window.supabase.createClient(
                            'https://rxriiwrirhdqhhegmbku.supabase.co',
                            'sb_publishable_AikWPC8foHSkbGuU8rUBcg_zjocndsx'
                        );
                    },
                    atmoWeightMap: {
                        1: 1.0000, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
                        6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
                    },
                    selectCover() {
                        this.$refs.coverInput.click();
                    },
                    handleCoverChange(event) {
                        const file = event.target.files[0];
                        if (!file || !file.type.startsWith('image/')) return;
                        const reader = new FileReader();
                        reader.onload = () => {
                            this.coverUrl = reader.result;
                        };
                        reader.readAsDataURL(file);
                        event.target.value = '';
                    },
                    async saveReview() {
                        this.errorMessage = '';
                        const title = this.reviewTitle.trim();
                        const text = this.reviewText.trim();
                        if (!title || !text) {
                            this.errorMessage = 'Заполни заголовок и текст рецензии';
                            return;
                        }

                        if (!this.supabase) {
                            this.errorMessage = 'Нет подключения к базе данных';
                            return;
                        }

                        const review = {
                            track_name: this.trackName.trim(),
                            artist_name: this.artistName.trim(),
                            release_type: this.releaseType,
                            review_title: title,
                            review_text: text,
                            cover_url: this.coverUrl,
                            scores: {
                                rhymes: this.rhymes,
                                structure: this.structure,
                                realize: this.realize,
                                individual: this.individual,
                                atmo: this.atmo
                            },
                            total: Math.round(this.total)
                        };

                        this.saving = true;
                        const { error } = await this.supabase.from('reviews').insert(review);
                        this.saving = false;

                        if (error) {
                            this.errorMessage = 'Не удалось сохранить рецензию: ' + error.message;
                            return;
                        }

                        window.location.href = 'reviews.html';
                    },
                    resetForm() {
                        this.trackName = '';
                        this.artistName = '';
                        this.releaseType = 'single';
                        this.reviewTitle = '';
                        this.reviewText = '';
                        this.rhymes = 5;
                        this.structure = 5;
                        this.realize = 5;
                        this.individual = 5;
                        this.atmo = 1;
                        this.coverUrl = null;
                        this.errorMessage = '';
                    },
                    get total() {
                        const base = (this.rhymes + this.structure + this.realize + this.individual) * 1.4;
                        const atmoMultiplier = this.atmoWeightMap[this.atmo];
                        return base * atmoMultiplier;
                    }
                }" x-init="initSupabase()">
                <div class="grid grid-cols-1 grid-rows-[auto_150px] md:grid-cols-[7.5rem_1fr] md:grid-rows-1 gap-4 justify-center items-center bg-neutral-800 p-4 rounded-2xl mb-4">
                    <div class="w-full aspect-square overflow-hidden rounded-lg relative flex items-center justify-center bg-neutral-700 hover:opacity-80">
                        <input x-ref="coverInput" @change="handleCoverChange" class="hidden" type="file" accept="image/*">
                        <button @click="selectCover" class="w-full h-full rounded-lg overflow-hidden relative cursor-pointer" type="button">
                            <template x-if="coverUrl">
                                <img class="w-full h-full object-cover" :src="coverUrl" alt="Обложка">
                            </template>
                            <template x-if="!coverUrl">
                                <span class="h-full w-full flex items-center justify-center text-xs text-neutral-300 px-2 text-center">Нажми, чтобы загрузить обложку</span>
                            </template>
                        </button>
                    </div>
                    <form class="flex flex-col gap-2 justify-between h-full" @submit.prevent>
                        <input class="border border-neutral-700 rounded-lg px-2 h-full font-medium" x-model="trackName" type="text" placeholder="Название">
                        <input class="border border-neutral-700 rounded-lg px-2 h-full" x-model="artistName" type="text" placeholder="Исполнитель">
                        <select class="border border-neutral-700 rounded-lg px-2 h-full appearance-none text-neutral-400" x-model="releaseType" name="type" id="type">
                            <option class="text-black" value="single">Сингл</option>
                            <option class="text-black" value="album">Альбом</option>
                        </select>
                    </form>
                </div>
                <div class="grid grid-cols-1 gap-4 bg-gray-900 border border-gray-600 p-4 rounded-2xl mb-4">
                    <article class="grid grid-cols-[1fr_auto] gap-2 w-full text-base font-semibold items-center">
                        <p>Рифмы/Образы</p>
                        <span class="justify-self-end text-lg" x-text="rhymes"></span>
                        <input class="w-full col-span-2 accent-blue-700 cursor-grab" x-model.number="rhymes" type="range" name="volume" id="volume" min="1" max="10" value="5">
                    </article>
                    <article class="grid grid-cols-[1fr_auto] gap-2 w-full text-base font-semibold items-center">
                        <p>Структура</p>
                        <span class="justify-self-end text-lg" x-text="structure"></span>
                        <input class="w-full col-span-2 accent-blue-700 cursor-grab" x-model.number="structure" type="range" name="volume" id="volume" min="1" max="10" value="5">
                    </article>
                    <article class="grid grid-cols-[1fr_auto] gap-2 w-full text-base font-semibold items-center">
                        <p>Реализация</p>
                        <span class="justify-self-end text-lg" x-text="realize"></span>
                        <input class="w-full col-span-2 accent-blue-700 cursor-grab" x-model.number="realize" type="range" name="volume" id="volume" min="1" max="10" value="5">
                    </article>
                    <article class="grid grid-cols-[1fr_auto] gap-2 w-full text-base font-semibold items-center">
                        <p>Индивидуальность/Харизма</p>
                        <span class="justify-self-end text-lg" x-text="individual"></span>
                        <input class="w-full col-span-2 accent-blue-700 cursor-grab" x-model.number="individual" type="range" name="volume" id="volume" min="1" max="10" value="5">
                    </article>
                </div>
                    <article class="grid grid-cols-[1fr_auto] gap-2 w-full text-base font-semibold items-center bg-violet-950 border border-violet-800 p-4 rounded-2xl mb-4">
                        <p>Атмосфера/Вайб</p>
                        <span class="justify-self-end text-lg" x-text="atmo"></span>
                        <input class="w-full col-span-2 accent-violet-400 cursor-grab" x-model.number="atmo" type="range" name="volume" id="volume" min="1" max="10" value="1">
                    </article>
                <section class="w-full gap-2 flex flex-col mb-4">
                    <input class="w-full border border-neutral-700 rounded-lg p-2 font-medium" x-model="reviewTitle" type="text" placeholder="Заголовок рецензии">
                    <textarea class="w-full border border-neutral-700 rounded-lg p-2 text-sm" x-model="reviewText" name="" id="" placeholder="Текст рецензии (до 500 символов)" maxlength="500"></textarea>
                    <p class="text-sm text-red-400" x-show="errorMessage" x-text="errorMessage"></p>
                </section>
                <div class="grid grid-cols-[auto_1fr_auto] gap-4 items-center">
                    <button @click="resetForm" class="flex justify-center items-center bg-neutral-800 text-neutral-600 w-10 h-10 rounded-lg cursor-pointer hover:bg-neutral-700" type="button">
                        <img class="h-full invert opacity-40 p-2" src="img/trash-can-svgrepo-com.svg" alt="">
                    </button>
                    <p class="relative right-6 justify-self-end">
                        <span class="text-4xl font-bold" x-text="Math.round(total)"></span>
                        <span class="absolute text-gray-400 ml-1">/90</span>
                    </p>
                    <button @click="saveReview" :disabled="saving" class="flex justify-center items-center bg-white text-black h-15 w-15 rounded-full cursor-pointer hover:opacity-80 disabled:opacity-50 disabled:cursor-not-allowed" type="button">✓</button>
                </div>
                
            </section>
        </main>
    </div>
    
</body>
</html>
